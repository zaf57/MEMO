<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MEMO</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" type="image/x-icon" href="MEMO.ico" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* Animation d‚Äôapparition + pulsation */
@keyframes fadeInScale {
  0% {
    opacity: 0;
    transform: scale(0.7);
    filter: blur(4px);
  }
  60% {
    opacity: 1;
    transform: scale(1.05);
    filter: blur(0);
  }
  100% {
    transform: scale(1);
  }
}

@keyframes pulse {
  0% {
    transform: scale(1);
    filter: drop-shadow(0 0 0 rgba(16, 185, 129, 0));
  }
  50% {
    transform: scale(1.05);
    filter: drop-shadow(0 0 15px rgba(16, 185, 129, 0.4));
  }
  100% {
    transform: scale(1);
    filter: drop-shadow(0 0 0 rgba(16, 185, 129, 0));
  }
}
</style>
</head>

<body class="min-h-screen bg-gradient-to-br from-gray-100 to-gray-200 flex flex-col items-center justify-center p-6">

<p id="todayDate" class="text-center text-gray-600 mb-4" style="color: white;"></p>

<div class="bg-white/90 rounded-2xl shadow-xl p-6 max-w-md w-full backdrop-blur" style="background-color: rgb(255, 245, 229);">

  <!-- Conteneur logo + boutons -->
  <div class="flex items-start gap-4 mb-4 mt-8" style="margin-top: 1px; margin-bottom: 2px;">
    <img id="MEMOtransp" src="https://zaf57.github.io/MEMO/MEMOtransp.png" alt="Logo MEMO" class="w-32 h-32"> 

    <div class="flex flex-col gap-3 flex-1">
      <button id="voiceBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2 px-4 rounded-lg">üéôÔ∏è Ajouter </button>
      <button id="readList" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-lg">üîä Tout Lire </button>
      </div>
  </div>

      <p id="status" class="text-sm text-gray-600 mt-2 text-center" style="
    margin-top: 1px;
    margin-bottom: 4px;
">Dis : ‚ÄúAjoute arroser les plantes‚Äù</p>
      <p id="result" class="text-green-700 font-semibold text-center"></p>
 
  <!-- Liste des t√¢ches -->
  <div id="taskList" class="space-y-2">
    <div class="text-gray-400 text-center">Chargement...</div>
  </div> 
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbzTOzWTlwTNC0uY11KmuQji9cE4d4KMMGdh2P3mXiy3sJnGkyza9DBf42avaXFBvMou4Q/exec"; 
const taskList = document.getElementById("taskList");
const result = document.getElementById("result");
const status = document.getElementById("status");
const voiceBtn = document.getElementById("voiceBtn");
let tasks = [];

// -------- UTILITAIRES --------
function speak(text){
  if(!("speechSynthesis" in window)) return;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang="fr-FR";
  utter.rate=1;
  window.speechSynthesis.speak(utter);
}

function formatDateForDisplay(dateStr) {
  if (!dateStr) return "";
  if (dateStr.includes("T")) {
    const d = new Date(dateStr);
    if (isNaN(d)) return "";
    return `${String(d.getDate()).padStart(2, "0")}/${String(d.getMonth() + 1).padStart(2, "0")}`;
  }
  const parts = dateStr.split(/[\/\-]/).map(Number);
  if (parts.length >= 2) {
    const [d, m] = parts;
    return `${String(d).padStart(2, "0")}/${String(m).padStart(2, "0")}`;
  } 
  return "";
}

function getBgColorFromDate(dateStr) {
  if (!dateStr) return "#04785730";
  const formatted = formatDateForDisplay(dateStr);
  const [d, m] = formatted.split("/").map(Number);
  if (!d || !m) return "#04785730";
  const taskDate = new Date(new Date().getFullYear(), m - 1, d);
  const diffDays = Math.floor((new Date() - taskDate) / (1000 * 60 * 60 * 24));
  if (diffDays >= 3) return "#f8717130";
  if (diffDays >= 1) return "#fbbf2430";
  return "#04785730";
}

// -------- AFFICHAGE --------
function renderTasks() {
  taskList.innerHTML = "";
  if (!tasks || tasks.length === 0) {
    taskList.innerHTML = "<div class='text-gray-500 text-center'>Aucune t√¢che</div>";
    return;
  }

  const fragment = document.createDocumentFragment();
  tasks.forEach(row => {
    if (row.tache) {
      const div = document.createElement("div");
      div.className = "flex justify-between items-center p-2 rounded-lg task-item"; 
      div.style.backgroundColor = getBgColorFromDate(row.date);
      const dateStr = formatDateForDisplay(row.date);
      div.innerHTML = `
        <span>‚úÖ ${row.tache} <span class="text-gray-400 text-sm">(${dateStr})</span></span>
        <button class="delete-btn text-red-600" data-id="${row.id}">üóëÔ∏è</button>
      `;
      fragment.appendChild(div);
    }
  });
  taskList.appendChild(fragment);

  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", async e => {
      const id = Number(e.target.getAttribute("data-id"));
      await deleteTask(id);
    });
  });
}

// -------- CHARGEMENT --------
async function loadList(force = false) {
  if (tasks.length > 0 && !force) {
    renderTasks();
    return;
  }

  try {
    const res = await fetch(scriptURL);
    tasks = await res.json();
    tasks = tasks.map(t => ({ ...t, date: formatDateForDisplay(t.date) }));
    renderTasks();
  } catch (err) {
    taskList.innerHTML = "<div class='text-red-500 text-center'>Erreur de chargement</div>";
    console.error(err);
  }
}

// -------- SUPPRESSION --------
async function deleteTask(id) {
  const itemDiv = document.querySelector(`.delete-btn[data-id="${id}"]`)?.closest("div");
  if(!itemDiv) return;
  itemDiv.classList.add("fade-out");
  setTimeout(async ()=>{
    try{
      const res = await fetch(scriptURL, {
        method:"POST",
        body: JSON.stringify({action:"delete", id})
      });
      const json = await res.json();
      if(json.ok){
        new Audio("recycle-bin.mp3").play();
        tasks = tasks.filter(t => t.id != id);
        renderTasks();
      } else alert("Erreur serveur : "+(json.error||""));
    }catch(err){
      alert("Erreur r√©seau : "+err.message);
    }
  },400);
}

// -------- VOIX --------
voiceBtn.addEventListener("click", ()=>{
  if(!("webkitSpeechRecognition" in window)){
    alert("La reconnaissance vocale n'est pas support√©e sur ce navigateur (Chrome requis).");
    return;
  }
  const rec = new webkitSpeechRecognition();
  rec.lang="fr-FR";
  rec.start();
  status.textContent="üéß J'√©coute...";
  rec.onresult=async ev=>{
    const phrase = ev.results[0][0].transcript;
    status.textContent="üó£Ô∏è "+phrase;
    try{
      const res = await fetch(scriptURL, {
        method:"POST",
        body: JSON.stringify({action:"add", tache: phrase})
      });
      const json = await res.json();
      if(json.ok){
        const today = new Date();
        const dateStr = `${String(today.getDate()).padStart(2,"0")}/${String(today.getMonth()+1).padStart(2,"0")}`;
        const newTask = { id: json.id || Date.now(), tache: phrase, date: dateStr };
        tasks.push(newTask);
        renderTasks();
        result.textContent="T√¢che ajout√©e ‚úÖ";
        speak("T√¢che ajout√©e");
      } else result.textContent="Erreur serveur : "+(json.error||"");
    }catch(err){
      result.textContent="Erreur r√©seau : "+err.message;
    }
  };
  rec.onerror=()=>{status.textContent="‚ùå Erreur de reconnaissance vocale";};
});

// -------- LECTURE --------
document.getElementById("readList").addEventListener("click", async ()=>{
  try{
    const res = await fetch(scriptURL);
    const data = await res.json();
    if(!data || data.length===0){speak("Aucune t√¢che √† lire");return;}
    let phrase="Voici vos t√¢ches : ";
    data.forEach(row=>phrase+=row.tache+", ");
    speak(phrase);
  }catch{ speak("Erreur lors de la lecture"); }
});

// -------- DATE D'AUJOURD'HUI --------
document.getElementById("todayDate").textContent =
  new Date().toLocaleDateString('fr-FR', {weekday:'long', year:'numeric', month:'long', day:'numeric'});

// -------- D√âMARRAGE --------
loadList();
</script>

</body>
</html>
