<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <title>MEMO</title>
  <link rel="icon" type="image/x-icon" href="MEMO.ico">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .fade-out {
      opacity: 0;
      transition: opacity 0.4s ease-out;
    }

    /* Animation d‚Äôapparition + pulsation */
    @keyframes fadeInScale {
      0% { opacity: 0; transform: scale(0.7); filter: blur(4px); }
      60% { opacity: 1; transform: scale(1.05); filter: blur(0); }
      100% { transform: scale(1); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(16,185,129,0)); }
      50% { transform: scale(1.05); filter: drop-shadow(0 0 15px rgba(16,185,129,0.4)); } 
    }

    .fade-in-scale { animation: fadeInScale 0.5s ease-out forwards; }
    .pulse-logo { animation: pulse 2s infinite; }

    .to-gray-200 {
    --tw-gradient-to: #000000 var(--tw-gradient-to-position);
}
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-gray-100 flex flex-col items-center justify-center p-6" 
  style="
  background-image: url(https://images.pexels.com/photos/268349/pexels-photo-268349.jpeg);
  background-size: 555px;background-position: -125px 0%;
  background-position: -92px 0%;
  justify-content: start;
  ">

  <p id="todayDate" class="text-center text-gray-600 mb-4" style="color:white;margin-bottom: 2px;"></p>

<!-- Logo et texte -->
<div class="logo" style="display: flex; align-items: center; gap: 12px;">
  <img id="MEMOtransp" 
       src="MEMOtransp.png" 
       alt="Logo MEMO" 
       class="fade-in-scale pulse-logo" 
       style="width: 80px; height: 80px;">

  <div style="display: flex; flex-direction: column; align-items: flex-start;">
    <strong style="font-size: 32px;color: #103438;margin-left: 10px;">MEMO</strong>
    <span style="color: #aaaaaa9e;font-size: 9px;margin-bottom: unset;margin-left: 10px;">N'oublie plus tes T√¢ches</span>
  </div>
</div>

<div class="bg-white/90 rounded-2xl shadow-xl p-6 max-w-md w-full backdrop-blur" style="background-color: #ffffff00;--tw-shadow: space-between; padding-top: 2px;">

  <!-- Boutons -->
<!-- Boutons -->
<div class="flex items-center gap-2 mb-4">
  <!-- Bouton micro / ajouter une t√¢che -->
  <button id="voiceBtn" class="voice-btn flex items-center justify-center gap-1 px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white">
    <img src="micro.svg" alt="Micro" class="w-5 h-5">
    <span>Ajouter une t√¢che</span>
  </button>

  <!-- Nouveau bouton lire üì¢ -->
  <button id="readBtn" class="read-btn flex items-center justify-center gap-1 px-3 py-2 rounded-lg bg-gray-300 hover:bg-gray-400 text-black">
    Lire
  </button>
</div>

  
    <!-- Champ manuel -->
<div class="flex gap-2 mb-3 items-center" style="margin-bottom: 1px;">
  <div class="relative flex-1">
    <!-- Ic√¥ne du stylo -->
    <img 
      src="writepen.svg" 
      alt="√âcrire" 
      class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 opacity-60 pointer-events-none z-10">

    <!-- Champ de texte -->
    <input
      id="manualTask"
      type="text"
      placeholder="√âcrire une t√¢che..."
      class="w-full border border-gray-300 rounded-lg pl-12 pr-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 placeholder-gray-400 bg-white">
  </div>

  <!-- Bouton d‚Äôajout -->
  <button
    id="addManual"
    class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 rounded-lg flex items-center justify-center"
    style="padding: 12px;">
    <img src="plus.svg" alt="Ajouter" class="w-5 h-5">
  </button>
</div>



    <p id="status" class="text-sm text-gray-600 mt-2 text-center" style="font-size: 10px;margin-top: 0px;">
      Dis : ‚Äúarroser les plantes‚Äù ou √©cris ci-dessus
    </p>

    <p id="voiceErrorHelp" class="text-center text-sm text-red-600 mt-2 hidden">
      ‚ùå Probl√®me avec la reconnaissance vocale ?
      <a href="tuto.html" class="text-blue-600 underline hover:text-blue-800">Voir le tutoriel</a>
    </p>

    <div id="taskList" class="space-y-2">
      <div class="text-gray-400 text-center">Chargement...</div>
    </div>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbx_qRpFyEMagjCBTLCYg-xsojIbkdciWc5vwuyQYwxZf2ioFT2TW00Vwelx9Dyx2lPLqw/exec";
    const taskList = document.getElementById("taskList");
    const status = document.getElementById("status");
    const voiceBtn = document.getElementById("voiceBtn");
    const manualInput = document.getElementById("manualTask");
    const addManual = document.getElementById("addManual");
    const voiceErrorHelp = document.getElementById("voiceErrorHelp");
    const readBtn = document.getElementById("readBtn");

    document.getElementById("todayDate").textContent = new Date().toLocaleDateString('fr-FR', {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });

    function speak(text) {
      if (!("speechSynthesis" in window)) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "fr-FR";
      utter.rate = 1;
      window.speechSynthesis.speak(utter);
    }
    


    async function loadList() {
      try {
        const res = await fetch(scriptURL);
        const data = await res.json();
        taskList.innerHTML = "";

        if (!data || data.length === 0) {
          taskList.innerHTML = "<div class='text-gray-500 text-center'>Aucune t√¢che</div>";
          return;
        }

        data.forEach(row => {
          if (row.tache) {
            const div = document.createElement("div");
            div.className = "flex justify-between items-center p-2 rounded-lg task-item";

            let bgColor = "#04785730";
            let dateStr = "";
            let diffDays = 0;

            if (row.date) {
              const dateObj = new Date(row.date);
              if (!isNaN(dateObj)) {
                const day = dateObj.getDate();
                const month = dateObj.getMonth() + 1;
                dateStr = `${String(day).padStart(2, "0")}/${String(month).padStart(2, "0")}`;
                const today = new Date();
                diffDays = Math.floor((today - dateObj) / (1000 * 60 * 60 * 24));
                if (diffDays >= 3) bgColor = "#f8717130";
                else if (diffDays >= 1) bgColor = "#fbbf2430";
              }
            }

            div.style.backgroundColor = bgColor;
            div.innerHTML = `
              <span> ${row.tache} <span class="text-gray-400 text-sm">(${dateStr})</span></span>
              <button class="delete-btn text-red-600 flex items-center justify-center" data-id="${Number(row.id)}"><img src="trash.svg" alt="Supprimer" class="trash-icon w-5 h-5 pointer-events-none"></button>
            `;
            taskList.appendChild(div);
          }
        });

        document.querySelectorAll(".delete-btn").forEach(btn => {
          btn.addEventListener("click", async e => {
            const id = Number(e.target.getAttribute("data-id"));
            await deleteTask(id);
          });
        });

      } catch (err) {
        taskList.innerHTML = "<div class='text-red-500 text-center'>Erreur de chargement</div>";
        console.error(err);
      }
    }

    // üéôÔ∏è Ajout vocal
    voiceBtn.addEventListener("click", () => {
      if (!("webkitSpeechRecognition" in window)) {
        alert("La reconnaissance vocale n'est pas support√©e sur ce navigateur (Chrome requis).");
        return;
      }

      const rec = new webkitSpeechRecognition();
      rec.lang = "fr-FR";
      rec.start();
      status.textContent = "üéß J'√©coute...";
      voiceErrorHelp.classList.add("hidden");

      rec.onresult = async ev => {
        const phrase = ev.results[0][0].transcript;
        status.textContent = "üó£Ô∏è " + phrase;
        await addTask(phrase);
      };

      rec.onerror = () => {
        status.textContent = "Erreur reconnaissance vocale";
        voiceErrorHelp.classList.remove("hidden");
      };
    });
    
    // üì¢ Bouton Lire
  readBtn.addEventListener("click", () => {
  const tasks = Array.from(document.querySelectorAll("#taskList .task-item span:first-child"))
                     .map(el => el.textContent.trim())
                     .filter(t => t.length > 0);

  if (tasks.length === 0) {
    speak("Aucune t√¢che dans la liste.");
    return;
  }

  speak("Voici vos t√¢ches : " + tasks.join(", "));
});

    // ‚úçÔ∏è Ajout manuel
    addManual.addEventListener("click", async () => {
      const text = manualInput.value.trim();
      if (text === "") return alert("Veuillez √©crire une t√¢che.");
      await addTask(text);
      manualInput.value = "";
    });

    manualInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        addManual.click();
      }
    });

    // ‚úÖ Fonction commune pour ajouter
    async function addTask(phrase) {
      try {
        const res = await fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify({ action: "add", tache: phrase })
        });
        const json = await res.json();
        if (json.ok) {
          speak("T√¢che ajout√©e");
          loadList();
        } else {
          alert("Erreur serveur : " + (json.error || ""));
        }
      } catch (err) {
        alert("Erreur r√©seau : " + err.message);
      }
    }

    // üóëÔ∏è Suppression
    async function deleteTask(id) {
      const itemDiv = document.querySelector(`.delete-btn[data-id="${id}"]`)?.closest("div");
      if (!itemDiv) return;
      itemDiv.classList.add("fade-out");

      setTimeout(async () => {
        try {
          const res = await fetch(scriptURL, {
            method: "POST",
            body: JSON.stringify({ action: "delete", id: Number(id) })
          });
          const json = await res.json();
          if (!json.ok) alert("Erreur serveur : " + (json.error || ""));
          new Audio("recycle-bin.mp3").play();
          loadList();
        } catch (err) {
          alert("Erreur r√©seau : " + err.message);
        }
      }, 400);
    }

    loadList();
  </script>

</body>
</html>
